#!/bin/bash

# Auto Repair Migrations Script
# This script automatically executes all the migration repair commands suggested by Supabase

set -e

echo "ðŸ”§ Auto Repair Migrations"
echo "========================="

# Check if we're in the right directory
if [ ! -f "supabase/config.toml" ]; then
    echo "[ERROR] Please run this script from the project root directory"
    exit 1
fi

echo "[WARNING] This will repair all migrations as suggested by Supabase."
echo "[WARNING] This may take a while as it executes many repair commands."
read -p "Are you sure you want to continue? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "[INFO] Operation cancelled"
    exit 1
fi

echo "[INFO] Starting automatic migration repair..."

# List of all migrations to mark as reverted (from the error output)
reverted_migrations=(
    "20240521000003"
    "20240521000004"
    "20240610000000"
    "20240622"
    "20240717000000"
    "20240730000000"
    "20240730000001"
    "20250103000002"
    "20250103000004"
    "20250108000000"
    "20250108000001"
    "20250108000004"
    "20250108000005"
    "20250109000001"
    "20250109000002"
    "20250109000003"
    "20250109040000"
    "20250109120000"
    "20250110000001"
    "20250111000000"
    "20250113000000"
    "20250114000000"
    "20250115000000"
    "20250115000001"
    "20250115000002"
    "20250116000001"
    "20250116180000"
    "20250116190000"
    "20250116200000"
    "20250117000000"
    "20250117000001"
    "20250117000003"
    "20250118000000"
    "20250118000001"
    "20250118000002"
    "20250118000004"
    "20250118000005"
    "20250119000000"
    "20250131000000"
    "20250606014049"
    "20250607032600"
    "20250607032700"
    "20250608120000"
    "20250608150000"
    "20250609150000"
    "20250612120000"
    "20250612121000"
    "20250612125000"
    "20250613090000"
    "20250613101500"
    "20250613103000"
    "20250613104000"
    "20250613120000"
    "20250619000000"
    "20250620000000"
    "20250620000100"
    "20250621000000"
    "20250621000001"
    "20250621000002"
    "20250621000004"
    "20250621000005"
    "20250621000006"
    "20250622020000"
    "20250622030000"
    "20250622041000"
    "20250623000000"
    "20250623010000"
    "20250623020000"
    "20250701000000"
    "20250707"
    "20250707145517"
    "20250719000726"
    "20250719020000"
    "20250719035607"
    "20250719044517"
    "20250719045521"
    "20250719045555"
    "20250719045731"
    "20250719045857"
    "20250719045901"
    "20250719045916"
    "20250719045921"
    "20250719045942"
    "20250719045946"
    "20250719050003"
    "20250719050008"
    "20250719050245"
    "20250719050413"
    "20250719050454"
    "20250719050501"
    "20250719050515"
    "20250719050527"
    "20250719050535"
    "20250719050543"
    "20250719051704"
    "20250719053850"
    "20250719054254"
    "20250719121520"
    "20250719121536"
    "20250719121859"
    "20250719122123"
    "20250719122141"
    "20250719122331"
    "20250719122351"
    "20250719122554"
    "20250719122616"
    "20250719122922"
    "20250719122956"
    "20250719123112"
    "20250719123200"
    "20250719123222"
    "20250720000000"
    "20250720120000"
    "20250727000000"
    "20250727000001"
    "20250727000002"
    "20250727000003"
    "20250727000004"
    "20250727000005"
    "20250727000006"
    "20250727000007"
    "20250727000008"
    "20250729180000"
)

echo "[INFO] Marking ${#reverted_migrations[@]} migrations as reverted..."
for migration in "${reverted_migrations[@]}"; do
    echo "[INFO] Repairing migration: $migration (status: reverted)"
    pnpm supabase migration repair --status reverted "$migration" || {
        echo "[WARNING] Failed to repair migration $migration (this might be expected)"
    }
done

echo "[SUCCESS] All migrations have been repaired!"
echo "[INFO] You can now run 'pnpm supabase db pull' to sync with remote" 